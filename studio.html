<!DOCTYPE html>
<html>
<head>
    <title>BlokStudio - Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #111; color: white; display: flex; font-family: sans-serif; overflow: hidden; }
        #tools { width: 300px; background: #1e1e1e; padding: 20px; border-right: 1px solid #333; height: 100vh; }
        #v { flex-grow: 1; height: 100vh; }
        input, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; }
        button { background: #3498db; cursor: pointer; border: none; font-weight: bold; }
    </style>
</head>
<body>
    <div id="tools">
        <h2>BlokStudio</h2>
        <p>Block Color</p>
        <input type="color" id="blockCol" value="#ffffff">
        <hr style="margin:20px 0; border:0; border-top:1px solid #333;">
        <h3>Game Settings</h3>
        <input type="text" id="gameName" placeholder="Game Name...">
        <p>Thumbnail File:</p>
        <input type="file" id="thumbFile" accept="image/*">
        <button onclick="saveGame()" style="background:#2ecc71; margin-top: 30px;">PUBLISH</button>
    </div>
    <div id="v"></div>

    <script>
        let scene, camera, renderer, raycaster, mouse;
        let blocks = [], thumbData = "";

        // Handle File Upload
        document.getElementById('thumbFile').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function() { thumbData = reader.result; };
            reader.readAsDataURL(e.target.files[0]);
        });

        function init() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x222222);
            camera = new THREE.PerspectiveCamera(75, (window.innerWidth-300)/window.innerHeight, 0.1, 1000);
            camera.position.set(10, 10, 10); camera.lookAt(0,0,0);
            
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth-300, window.innerHeight);
            document.getElementById('v').appendChild(renderer.domElement);

            scene.add(new THREE.GridHelper(40, 40, 0x444444, 0x222222));
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));

            // Hidden floor for the first block
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(40,40), new THREE.MeshBasicMaterial({visible:false}));
            floor.rotation.x = -Math.PI/2; scene.add(floor);

            raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

            window.addEventListener('mousedown', (e) => {
                if(e.clientX < 300) return;
                mouse.x = ((e.clientX - 300) / (window.innerWidth - 300)) * 2 - 1;
                mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const hits = raycaster.intersectObjects(scene.children);
                
                if(hits.length > 0) {
                    const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: document.getElementById('blockCol').value}));
                    // Place exactly on the face hit
                    b.position.copy(hits[0].point).add(hits[0].face.normal).floor().addScalar(0.5);
                    scene.add(b); blocks.push(b);
                }
            });

            function anim() { requestAnimationFrame(anim); renderer.render(scene, camera); }
            anim();
        }

        function saveGame() {
            const name = document.getElementById('gameName').value || "Unnamed Game";
            const gameData = {
                name: name,
                thumb: thumbData || "https://placehold.co/400x300?text=No+Image",
                blocks: blocks.map(b => ({ pos: b.position, col: b.material.color.getHex() }))
            };
            const allGames = JSON.parse(localStorage.getItem('blokie_games')) || [];
            allGames.push(gameData);
            localStorage.setItem('blokie_games', JSON.stringify(allGames));
            alert("Game Published!"); window.close();
        }
        init();
    </script>
</body>
</html>
