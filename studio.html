<!DOCTYPE html>
<html>
<head><title>BlokStudio</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script></head>
<body style="margin:0; background:#111; color:white; font-family:sans-serif; display:flex; height:100vh; overflow:hidden;">
    <div style="width:300px; background:#1e1e1e; padding:25px; border-right:1px solid #333; box-sizing:border-box;">
        <h2 style="color:#2ecc71; margin-top:0;">BlokStudio</h2>
        <p>Paint Color</p>
        <input type="color" id="blockCol" value="#ffffff" style="width:100%; height:45px; border:none; cursor:pointer;">
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <input type="text" id="gName" placeholder="World Name" style="width:100%; padding:12px; background:#222; border:1px solid #444; color:white; border-radius:4px; box-sizing:border-box;">
        <p>Thumbnail Image</p>
        <input type="file" id="thumbInput" accept="image/*" style="width:100%; font-size:0.8rem;">
        <button onclick="save()" style="width:100%; padding:15px; background:#2ecc71; border:none; color:white; font-weight:bold; margin-top:25px; cursor:pointer; border-radius:4px;">PUBLISH WORLD</button>
        <p style="font-size:0.7rem; color:#888; margin-top:15px;">Left Click: Place<br>Right Click: Delete</p>
    </div>
    <div id="viewport" style="flex-grow:1;"></div>
    <script>
        let scene = new THREE.Scene(), camera = new THREE.PerspectiveCamera(75, (window.innerWidth-300)/window.innerHeight, 0.1, 1000), renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth-300, window.innerHeight); document.getElementById('viewport').appendChild(renderer.domElement);
        scene.background = new THREE.Color(0x1a1a1a);
        scene.add(new THREE.GridHelper(50,50,0x444444,0x222222), new THREE.AmbientLight(0xffffff,0.8)); camera.position.set(15,15,15); camera.lookAt(0,0,0);
        
        let blocks = [], thumbData = "", ray = new THREE.Raycaster(), mouse = new THREE.Vector2();
        
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshBasicMaterial({visible:false}));
        floor.rotation.x = -Math.PI/2; scene.add(floor);

        document.getElementById('thumbInput').onchange = e => {
            const reader = new FileReader();
            reader.onload = () => thumbData = reader.result;
            reader.readAsDataURL(e.target.files[0]);
        };

        window.addEventListener('contextmenu', e => e.preventDefault());
        window.addEventListener('mousedown', e => {
            if(e.clientX < 300) return;
            mouse.x = ((e.clientX-300)/(window.innerWidth-300))*2-1; mouse.y = -(e.clientY/window.innerHeight)*2+1;
            ray.setFromCamera(mouse, camera); const hits = ray.intersectObjects(scene.children);
            if(hits.length > 0) {
                if(e.button === 0) { // Place
                    const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:document.getElementById('blockCol').value}));
                    b.position.copy(hits[0].point).add(hits[0].face.normal).floor().addScalar(0.5);
                    scene.add(b); blocks.push(b);
                } else if(e.button === 2 && hits[0].object !== floor) { // Delete
                    scene.remove(hits[0].object); blocks = blocks.filter(blk => blk !== hits[0].object);
                }
            }
        });

        function save() {
            const games = JSON.parse(localStorage.getItem('blokie_games')) || [];
            games.push({
                name: document.getElementById('gName').value || "Unnamed World",
                thumb: thumbData || "https://placehold.co/400x300?text=Blokie+Game",
                blocks: blocks.map(b => ({pos: b.position, col: b.material.color.getHex()}))
            });
            localStorage.setItem('blokie_games', JSON.stringify(games)); alert("Published to Discovery!"); window.close();
        }
        function anim() { requestAnimationFrame(anim); renderer.render(scene, camera); } anim();
    </script>
</body>
</html>
