<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BlokStudio - Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #111; color: white; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 300px; background: #1e1e1e; border-right: 1px solid #333; padding: 20px; box-sizing: border-box; }
        #viewport { flex-grow: 1; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 4px; background: #3498db; }
        #pub-menu { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #252525; padding: 30px; border-radius: 12px; border: 1px solid #444; width: 340px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #111; border: 1px solid #444; color: white; box-sizing: border-box; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2 style="color:#2ecc71">BLOKSTUDIO</h2>
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <p>Part Color</p>
        <input type="color" id="block-col" value="#ffffff" style="width:100%; height:45px; cursor:pointer;">
        <button onclick="document.getElementById('pub-menu').style.display='block'" style="background:#2ecc71">SAVE & PUBLISH</button>
        <button onclick="window.close()" style="background:#555">EXIT STUDIO</button>
        <p style="font-size: 0.75rem; color: #777; margin-top: 30px;">Left-Click: Place Block<br>Right-Click: Delete Block</p>
    </div>
    
    <div id="viewport"></div>

    <div id="pub-menu">
        <h3 style="margin-top:0">Publish Game</h3>
        <input type="text" id="g-name" placeholder="Game Name">
        <input type="text" id="g-thumb" placeholder="Thumbnail Image URL">
        <button onclick="publish()">PUBLISH TO HUB</button>
        <button onclick="this.parentElement.style.display='none'" style="background:none; border:1px solid #555">Cancel</button>
    </div>

    <script>
        let scene, camera, renderer, raycaster, mouse;
        let blocks = [];

        function init() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x1a1a1a);
            camera = new THREE.PerspectiveCamera(75, (window.innerWidth-300)/window.innerHeight, 0.1, 1000);
            camera.position.set(12, 12, 12); camera.lookAt(0,0,0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth-300, window.innerHeight);
            document.getElementById('viewport').appendChild(renderer.domElement);
            
            scene.add(new THREE.GridHelper(50, 50, 0x444444, 0x222222));
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));

            const plane = new THREE.Mesh(new THREE.PlaneGeometry(50,50), new THREE.MeshBasicMaterial({visible:false}));
            plane.rotation.x = -Math.PI/2; scene.add(plane);
            raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

            window.addEventListener('contextmenu', e => e.preventDefault());
            window.addEventListener('mousedown', e => {
                if(e.clientX < 300) return;
                mouse.x = ((e.clientX - 300) / (window.innerWidth - 300)) * 2 - 1;
                mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const hits = raycaster.intersectObjects(scene.children);
                
                if(hits.length > 0) {
                    if(e.button === 0) {
                        const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: document.getElementById('block-col').value}));
                        b.position.copy(hits[0].point).add(hits[0].face.normal).floor().addScalar(0.5);
                        scene.add(b); blocks.push(b);
                    } else if(e.button === 2 && hits[0].object !== plane && hits[0].object.type !== "GridHelper") {
                        scene.remove(hits[0].object);
                        blocks = blocks.filter(b => b !== hits[0].object);
                    }
                }
            });
            animate();
        }

        function publish() {
            const data = {
                name: document.getElementById('g-name').value || "New Adventure",
                thumb: document.getElementById('g-thumb').value || "https://placehold.co/400x300/222/fff?text=Blokie+Game",
                blocks: blocks.map(b => ({ pos: b.position.clone(), col: b.material.color.getHex() }))
            };
            const games = JSON.parse(localStorage.getItem('blokie_published_games')) || [];
            games.push(data);
            localStorage.setItem('blokie_published_games', JSON.stringify(games));
            alert("Success! Your game is live in the Worlds hub.");
            window.close();
        }

        function animate() { requestAnimationFrame(animate); renderer.render(scene, camera); }
        init();
    </script>
</body>
</html>