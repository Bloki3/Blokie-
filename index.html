<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blokie - Corporate OS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --bg: #0a0a0b; --panel: #161618; --accent: #2ecc71; --text: #f0f0f0; --sub: #888; --border: rgba(255,255,255,0.08); }
        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100%; overflow: hidden; }
        
        /* Modern Glass Navigation */
        nav { background: rgba(18, 18, 20, 0.8); backdrop-filter: blur(10px); height: 65px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .nav-tabs { display: flex; gap: 10px; }
        .tab { color: var(--sub); cursor: pointer; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        .tab i { font-size: 1rem; }
        .tab:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab.active { background: rgba(46, 204, 113, 0.1); color: var(--accent); }

        /* Discovery Grid */
        .view { display: none; height: calc(100vh - 65px); overflow-y: auto; padding: 40px; box-sizing: border-box; }
        .view.active { display: block; }
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .game-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: 0.3s; cursor: pointer; }
        .game-card:hover { transform: translateY(-5px); border-color: var(--accent); box-sizing: border-box; }
        .game-card img { width: 100%; height: 160px; object-fit: cover; }
        .card-meta { padding: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* Game Menu */
        .menu-container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 400px; gap: 30px; }
        .btn-play { background: var(--accent); color: #000; border: none; padding: 15px 40px; border-radius: 8px; font-weight: 800; cursor: pointer; width: 100%; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Engine Overlay */
        #ui-overlay { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 8px; font-size: 0.8rem; color: #fff; pointer-events: none; }
    </style>
</head>
<body onload="initApp()">

    <nav id="main-nav" style="display:none;">
        <div class="nav-tabs">
            <div class="tab active" onclick="switchTab('worlds')"><i class="fas fa-compass"></i> DISCOVER</div>
            <div class="tab" onclick="switchTab('avatar-tab')"><i class="fas fa-user-astronaut"></i> AVATAR</div>
            <div class="tab" onclick="window.open('studio.html', '_blank')"><i class="fas fa-tools"></i> STUDIO</div>
        </div>
        <div style="font-size: 0.8rem; letter-spacing: 2px; font-weight: 800; color: var(--accent);">BLOKIE // OS</div>
    </nav>

    <div id="auth-view" class="active" style="height:100vh; display:flex; align-items:center; justify-content:center;">
        <div style="text-align:center; background:var(--panel); padding:50px; border-radius:20px; border:1px solid var(--border); width:350px;">
            <i class="fas fa-shield-halved" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2 style="margin:0; letter-spacing:3px;">AUTHENTICATE</h2>
            <p style="color:var(--sub); font-size:0.75rem; margin-bottom:30px;">SECURE ACCESS TO CREATIVE UNIVERSE</p>
            <input type="text" id="u-in" placeholder="CREDENTIALS" style="width:100%; padding:14px; background:#000; border:1px solid var(--border); color:#fff; border-radius:8px; margin-bottom:20px; text-align:center;">
            <button class="btn-play" onclick="handleLogin()">INITIALIZE <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="worlds" class="view">
        <h1 style="margin-bottom:30px; font-weight:300;">Available <span style="color:var(--accent); font-weight:600;">Worlds</span></h1>
        <div class="card-grid" id="featured-list"></div>
    </div>

    <div id="game-menu" class="view">
        <div class="menu-container">
            <div>
                <h1 id="m-title" style="font-size:3rem; margin:0;">Project Name</h1>
                <p id="m-desc" style="color:var(--sub); font-size:1.1rem; line-height:1.6; margin:20px 0;">A user-generated simulation. Use WASD to move and SPACE to jump once initialized.</p>
                <button class="btn-play" onclick="launchGame()"><i class="fas fa-play"></i> LAUNCH SIMULATION</button>
                <button onclick="switchTab('worlds')" style="background:none; border:none; color:var(--sub); margin-top:20px; cursor:pointer;"><i class="fas fa-chevron-left"></i> Return to Discovery</button>
            </div>
            <img id="m-thumb" src="" style="width:100%; border-radius:15px; border:1px solid var(--border);">
        </div>
    </div>

    <div id="avatar-tab" class="view">
        <div class="menu-container">
            <div class="panel" style="background:var(--panel); padding:30px; border-radius:15px;">
                <h3>IDENTITY CONFIG</h3>
                <label style="font-size:0.7rem; color:var(--sub);">SKIN TONE</label>
                <input type="color" id="char-skin" value="#ecf0f1" style="width:100%; height:40px; margin-bottom:20px; border:none; background:none;">
                <label style="font-size:0.7rem; color:var(--sub);">SUIT COLOR</label>
                <input type="color" id="char-shirt" value="#34495e" style="width:100%; height:40px; margin-bottom:20px; border:none; background:none;">
                <button class="btn-play" onclick="saveLook()">APPLY UPDATE</button>
            </div>
            <div style="display:flex; align-items:center; justify-content:center; background:#000; border-radius:15px;">
                <div id="p-preview-box">
                    <div id="p-head" style="width:40px; height:40px; background:#ecf0f1; margin:0 auto; border-radius:4px;"></div>
                    <div id="p-body" style="width:70px; height:90px; background:#34495e; margin:5px auto; border-radius:4px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="engine-view" style="display:none; position:relative;">
        <div id="canvas-container"></div>
        <div id="ui-overlay"><b>CONTROLS:</b> WASD to Move | SPACE to Jump</div>
        <button onclick="location.reload()" style="position:absolute; top:20px; left:20px; background:rgba(255,0,0,0.2); color:#ff4d4d; border:1px solid #ff4d4d; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">DISCONNECT</button>
    </div>

    <script>
        let deferredPrompt;
        let myLook = { shirt: "#34495e", skin: "#ecf0f1" };
        let keys = {};

        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        function initApp() { if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js'); loadGames(); }

        function handleLogin() {
            if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; }
            document.getElementById('auth-view').style.display = 'none';
            document.getElementById('main-nav').style.display = 'flex';
            switchTab('worlds');
        }

        function switchTab(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // Correct logic to highlight tab
            const tabs = document.querySelectorAll('.tab');
            if(id === 'worlds') tabs[0].classList.add('active');
            if(id === 'avatar-tab') tabs[1].classList.add('active');
        }

        function loadGames() {
            const list = document.getElementById('featured-list');
            const games = JSON.parse(localStorage.getItem('blokie_games')) || [];
            list.innerHTML = "";
            games.forEach(g => {
                const d = document.createElement('div');
                d.className = "game-card";
                d.innerHTML = `<img src="${g.thumb}"><div class="card-meta"><b>${g.name.toUpperCase()}</b><i class="fas fa-play-circle" style="color:var(--accent)"></i></div>`;
                d.onclick = () => {
                    window.selectedGame = g;
                    document.getElementById('worlds').classList.remove('active');
                    document.getElementById('game-menu').classList.add('active');
                    document.getElementById('m-title').innerText = g.name;
                    document.getElementById('m-thumb').src = g.thumb;
                };
                list.appendChild(d);
            });
        }

        function saveLook() {
            myLook.shirt = document.getElementById('char-shirt').value;
            myLook.skin = document.getElementById('char-skin').value;
            document.getElementById('p-head').style.background = myLook.skin;
            document.getElementById('p-body').style.background = myLook.shirt;
            alert("Avatar Sync Complete");
        }

        function launchGame() {
            document.getElementById('game-menu').style.display = 'none';
            document.getElementById('main-nav').style.display = 'none';
            document.getElementById('engine-view').style.display = 'block';

            const scene = new THREE.Scene(); scene.background = new THREE.Color(0x050505);
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 0.5); sun.position.set(10,20,10); scene.add(sun);

            // Build Map
            window.selectedGame.blocks.forEach(b => {
                const m = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color:b.col}));
                m.position.set(b.pos.x, b.pos.y, b.pos.z); scene.add(m);
            });

            // Player Setup
            const player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8,1,0.4), new THREE.MeshStandardMaterial({color: myLook.shirt}));
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.5,0.5), new THREE.MeshStandardMaterial({color: myLook.skin}));
            head.position.y = 0.8; player.add(body); player.add(head);
            player.position.y = 2; scene.add(player);

            let vy = 0; 
            function update() {
                const speed = 0.15;
                if(keys['KeyW']) player.position.z -= speed;
                if(keys['KeyS']) player.position.z += speed;
                if(keys['KeyA']) player.position.x -= speed;
                if(keys['KeyD']) player.position.x += speed;
                if(keys['Space'] && player.position.y <= 1.1) vy = 0.2; // Simple Jump

                // Gravity
                player.position.y += vy;
                if(player.position.y > 1) vy -= 0.01; else { player.position.y = 1; vy = 0; }

                camera.position.lerp(new THREE.Vector3(player.position.x, player.position.y + 4, player.position.z + 8), 0.1);
                camera.lookAt(player.position);
            }

            function anim() { requestAnimationFrame(anim); update(); renderer.render(scene, camera); }
            anim();
        }
    </script>
</body>
</html>
